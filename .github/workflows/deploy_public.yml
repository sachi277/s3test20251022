name: ğŸš€ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—åŒæœŸæ–¹å¼ã«ã‚ˆã‚‹å…¬é–‹ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç†ç”±'
        required: true
        default: 'é€šå¸¸å…¬é–‹'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # IAMãƒ­ãƒ¼ãƒ«ã®å¼•ãå—ã‘ã‚’è¨±å¯
    permissions:
      id-token: write
      contents: read

    steps:
      - name: ğŸ“¦ ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # --- AWSèªè¨¼ ---
      - name: âš™ï¸ AWSèªè¨¼æƒ…å ±ã®è¨­å®š (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      # --- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡¦ç† ---
      - name: ğŸ’¾ Step 1: å…¬é–‹ãƒã‚±ãƒƒãƒˆã®ç¾è¡Œã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆã¸åŒæœŸ
        run: |
          echo "å…¬é–‹ãƒã‚±ãƒƒãƒˆ (${{ secrets.PUBLIC_BUCKET }}) ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆ (${{ secrets.BACKUP_BUCKET }}) ã¸åŒæœŸã—ã¾ã™ã€‚"
          # --delete: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆå´ã§å…¬é–‹ãƒã‚±ãƒƒãƒˆã«å­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã€å®Œå…¨ã«åŒæœŸ
          aws s3 sync s3://${{ secrets.PUBLIC_BUCKET }} s3://${{ secrets.BACKUP_BUCKET }} --delete

      # --- ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç† ---
      - name: ğŸ“¤ Step 2: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰å…¬é–‹ãƒã‚±ãƒƒãƒˆã¸æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åŒæœŸ
        run: |
          echo "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚±ãƒƒãƒˆ (${{ secrets.PREVIEW_BUCKET }}) ã‹ã‚‰å…¬é–‹ãƒã‚±ãƒƒãƒˆã¸åŒæœŸã—ã¾ã™ã€‚"
          aws s3 sync s3://${{ secrets.PREVIEW_BUCKET }} s3://${{ secrets.PUBLIC_BUCKET }} --delete

      # # --- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ– ---
      # - name: ğŸ’¨ CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç„¡åŠ¹åŒ–
      #   if: success()
      #   run: |
      #     aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
